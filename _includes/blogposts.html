<link rel="stylesheet" href="http://www.codeforamerica.org/blog/wp-content/themes/cfawp2012/style.css?ver=3.9.2">
<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>

<style>
    
</style>

<script type="text/x-template" id="blogTemplate">
  <section class="slab-gray">
    <div class="layout-semibreve">
      <header class="badge-heading badge-orange badge-fellowship">
        <h2>Team blog posts</h2>
      </header>

      <% var imagePost = _.find( posts, function(post){
        return post.featured_image !== null; 
      }); %>

      <% if (imagePost) { %>
        <%= imagePost.ID %>
      <% } %>

      <div class="layout-gutter">
        <% var otherPosts = _.reject( posts, function(post){ 
          return imagePost.ID == post.ID;
        }); %>

        <% _.each(otherPosts, function(post){ %>
        <article id="post-<%= post.ID %>" class="post-<%= post.ID %> post type-post status-publish format-standard hentry post-preview">
          <header class="post-header isolate">
            <h2 class="entry-title">
              <a href="<%= post.link %>" rel="bookmark"><%= post.title %></a>
            </h2>
          </header>
          
          <div class="text-whisper info">
            <span>Posted on </span>
            <% var date = makePrettyDate( post.date ); %>
            <time class="post-date insulate text-whisper published" datetime="<%= post.date %>"><%= date %></time>
            <span> by </span>
            <span class="post-author vcard">
              <a class="url fn n" href="http://www.codeforamerica.org/blog/author/<%= post.author.slug %>/"><%= post.author.name %></a>
            </span>
          </div>
          
          <div class="post-body">
            <div class="post-content">
              <% var content = stripHTML( post.content );
                 var excerpt = toExcerpt( content, 220 ); %>
              <p>
                <%= excerpt %>
                <a class="more-link" href="<%= post.link %>">Continue Reading</a>
              </p>
            </div>
          </div><!-- .post-body -->
        </article>
        <% }); /* end _.each */ %>
     
      </div><!-- end .layout-gutter -->
    </div><!-- end .layout-semibreve -->
  </section>
</script>

<script type="text/javascript">
    var stripHTML = function(html) {
    // Thanks to: http://stackoverflow.com/questions/822452/strip-html-from-text-javascript

    // Stripping the legal HTML tags
    html = html.replace(/<[^>]*>/g, '');

    // Escaping the remaining characters
    var div = document.createElement('div');
    div.textContent = html;
    return div.innerHTML;
  }

  var toExcerpt = function(content, length) {
    // content shouldn't have any html tags

    // Get the first 200 characters
    var excerpt = content.substring(0,length);

    // Add some dots
    excerpt += '...';

    return excerpt;
  }

  var makePrettyDate = function(date) {
    // date is a string, let's make it a date object
    var dateObject = new Date(date);

    // Make an array of the months, so we can get the month by name
    var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

    // Grab the month name out of the array
    var month = months[dateObject.getMonth()];

    // Get the day and year
    var day = dateObject.getDay();
    var year = dateObject.getFullYear();

    // Return the date
    prettyDate = month + " " + day + ", " + year;
    return prettyDate;
  }

  var handlePosts = function(data) {
    // If the endpoint gave us any data
    if (data.length > 0) {
      // Build the template
      var template = _.template(
        $( "#blogTemplate" ).html(),
        { variable: 'posts' }
      );

      // Write the template to DOM
      $('#js-blogposts').html(
        template(data)
      );

      return true;
    } else {
      console.log('No data in endpoint: {{ include.category }} ');
      return false;
    }
  }

  $(document).ready(function(){
    var url = "http://www.codeforamerica.org/blog/wp-json/posts?filter[category_name]={{ include.category }}";

    var getPosts = $.getJSON( url, function(data) {
      handlePosts(data);
    })
    .fail(function(error){
      console.log('failed to get' + url)
    });
  });

</script>